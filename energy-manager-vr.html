<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Manager VR | AI-Driven P2P Energy Trading Simulation</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Space+Grotesk:wght@300;500;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'IBM Plex Mono', monospace;
            background: #0a0a0f;
            color: #e0e0e0;
            overflow: hidden;
        }
        
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #0a0a0f 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.8s ease;
        }
        
        #loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(90deg, #00ff88, #00d4ff, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            letter-spacing: -0.02em;
        }
        
        .loading-subtitle {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 3rem;
            text-transform: uppercase;
            letter-spacing: 0.3em;
        }
        
        .loading-progress {
            width: 300px;
            height: 2px;
            background: #222;
            border-radius: 1px;
            overflow: hidden;
        }
        
        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00d4ff);
            width: 0%;
            animation: loading 2s ease-in-out forwards;
        }
        
        @keyframes loading {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }
        
        .vr-prompt {
            margin-top: 2rem;
            padding: 1rem 2rem;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 8px;
            font-size: 0.85rem;
            color: #00ff88;
        }
        
        #hud {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            pointer-events: none;
        }
        
        .hud-panel {
            background: rgba(10, 10, 15, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            min-width: 280px;
        }
        
        .hud-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: #00ff88;
            margin-bottom: 0.75rem;
        }
        
        .hud-value {
            font-size: 2rem;
            font-weight: 600;
            color: #fff;
        }
        
        .hud-unit {
            font-size: 0.8rem;
            color: #666;
            margin-left: 0.25rem;
        }
        
        .hud-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .hud-item {
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }
        
        .hud-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #666;
            margin-bottom: 0.25rem;
        }
        
        .hud-data {
            font-size: 1.1rem;
            color: #fff;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
            animation: pulse 2s infinite;
        }
        
        .status-good { background: #00ff88; }
        .status-warning { background: #ffaa00; }
        .status-critical { background: #ff4444; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        #decision-panel {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: none;
        }
        
        #decision-panel.active {
            display: block;
            animation: slideUp 0.4s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        .decision-card {
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 16px;
            padding: 2rem;
            max-width: 700px;
            text-align: center;
        }
        
        .scenario-time {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.3em;
            color: #00d4ff;
            margin-bottom: 0.5rem;
        }
        
        .scenario-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.5rem;
            font-weight: 500;
            color: #fff;
            margin-bottom: 1rem;
        }
        
        .scenario-context {
            font-size: 0.85rem;
            color: #999;
            line-height: 1.6;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }
        
        .decision-options {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .decision-btn {
            padding: 1rem 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #fff;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            pointer-events: auto;
            min-width: 180px;
        }
        
        .decision-btn:hover {
            background: rgba(0, 255, 136, 0.1);
            border-color: rgba(0, 255, 136, 0.5);
            transform: translateY(-2px);
        }
        
        .decision-btn .btn-icon {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 0.5rem;
        }
        
        #feedback-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 200;
            display: none;
        }
        
        #feedback-panel.active {
            display: block;
            animation: popIn 0.3s ease;
        }
        
        @keyframes popIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        .feedback-card {
            background: rgba(10, 10, 15, 0.98);
            backdrop-filter: blur(30px);
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 600px;
            text-align: center;
        }
        
        .feedback-card.optimal {
            border: 2px solid rgba(0, 255, 136, 0.5);
        }
        
        .feedback-card.suboptimal {
            border: 2px solid rgba(255, 170, 0, 0.5);
        }
        
        .feedback-card.poor {
            border: 2px solid rgba(255, 68, 68, 0.5);
        }
        
        .feedback-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .feedback-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .feedback-card.optimal .feedback-title { color: #00ff88; }
        .feedback-card.suboptimal .feedback-title { color: #ffaa00; }
        .feedback-card.poor .feedback-title { color: #ff4444; }
        
        .feedback-explanation {
            font-size: 0.9rem;
            color: #ccc;
            line-height: 1.7;
            margin-bottom: 1.5rem;
        }
        
        .ai-suggestion {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .ai-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: #8b5cf6;
            margin-bottom: 0.5rem;
        }
        
        .ai-text {
            font-size: 0.85rem;
            color: #e0e0e0;
        }
        
        .continue-btn {
            padding: 1rem 3rem;
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            border: none;
            border-radius: 30px;
            color: #0a0a0f;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .continue-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 40px rgba(0, 255, 136, 0.3);
        }
        
        #final-report {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 15, 0.98);
            z-index: 300;
            display: none;
            overflow-y: auto;
        }
        
        #final-report.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 3rem;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .report-container {
            max-width: 900px;
            width: 100%;
        }
        
        .report-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .report-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, #00ff88, #00d4ff, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        
        .report-subtitle {
            font-size: 0.85rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.2em;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 3rem;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
        }
        
        .metric-value {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .metric-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: #666;
        }
        
        .comparison-section {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .section-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.2rem;
            font-weight: 500;
            color: #fff;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .comparison-bars {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .bar-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .bar-label {
            width: 120px;
            font-size: 0.8rem;
            color: #999;
        }
        
        .bar-container {
            flex: 1;
            height: 24px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .bar-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 1s ease;
        }
        
        .bar-fill.user { background: linear-gradient(90deg, #00d4ff, #0099cc); }
        .bar-fill.ai { background: linear-gradient(90deg, #00ff88, #00cc6a); }
        
        .bar-value {
            width: 60px;
            text-align: right;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .insights-section {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(0, 212, 255, 0.1));
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .insight-item {
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-bottom: 1rem;
        }
        
        .insight-item:last-child {
            margin-bottom: 0;
        }
        
        .insight-heading {
            font-size: 0.9rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 0.5rem;
        }
        
        .insight-text {
            font-size: 0.85rem;
            color: #bbb;
            line-height: 1.6;
        }
        
        .academic-references {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .ref-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: #666;
            margin-bottom: 1rem;
        }
        
        .ref-item {
            font-size: 0.8rem;
            color: #999;
            margin-bottom: 0.5rem;
            padding-left: 1rem;
            border-left: 2px solid rgba(0, 255, 136, 0.3);
        }
        
        .restart-btn {
            display: block;
            margin: 2rem auto;
            padding: 1.25rem 4rem;
            background: transparent;
            border: 2px solid #00ff88;
            border-radius: 30px;
            color: #00ff88;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .restart-btn:hover {
            background: #00ff88;
            color: #0a0a0f;
        }
        
        .vr-enter-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
        }
        
        .vr-enter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.75rem;
            pointer-events: none;
            z-index: 500;
            max-width: 250px;
        }
        
        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .decision-options {
                flex-direction: column;
            }
            
            .hud-panel {
                min-width: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <h1 class="loading-title">Energy Manager VR</h1>
        <p class="loading-subtitle">AI-Driven P2P Energy Trading Simulation</p>
        <div class="loading-progress">
            <div class="loading-bar"></div>
        </div>
        <div class="vr-prompt">
            ü•Ω VR headset detected? Enter immersive mode for the full experience
        </div>
    </div>

    <!-- HUD Panel -->
    <div id="hud">
        <div class="hud-panel">
            <div class="hud-title">Community Energy Status</div>
            <div class="hud-value" id="time-display">06:00<span class="hud-unit">hrs</span></div>
        </div>
        <div class="hud-panel">
            <div class="hud-grid">
                <div class="hud-item">
                    <div class="hud-label">Solar Output</div>
                    <div class="hud-data" id="solar-output">0 kW</div>
                </div>
                <div class="hud-item">
                    <div class="hud-label">Wind Output</div>
                    <div class="hud-data" id="wind-output">2.1 kW</div>
                </div>
                <div class="hud-item">
                    <div class="hud-label">Battery</div>
                    <div class="hud-data" id="battery-level">50%</div>
                </div>
                <div class="hud-item">
                    <div class="hud-label">Grid Price</div>
                    <div class="hud-data" id="grid-price">¬£0.28</div>
                </div>
            </div>
        </div>
        <div class="hud-panel">
            <div class="hud-title">Your Performance</div>
            <div class="hud-grid">
                <div class="hud-item">
                    <div class="hud-label">Score</div>
                    <div class="hud-data" id="score">0</div>
                </div>
                <div class="hud-item">
                    <div class="hud-label">Renewable %</div>
                    <div class="hud-data" id="renewable-pct">0%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Decision Panel -->
    <div id="decision-panel">
        <div class="decision-card">
            <div class="scenario-time" id="scenario-time">06:00 - Early Morning</div>
            <h2 class="scenario-title" id="scenario-title">Scenario Loading...</h2>
            <p class="scenario-context" id="scenario-context">Loading context...</p>
            <div class="decision-options" id="decision-options"></div>
        </div>
    </div>

    <!-- Feedback Panel -->
    <div id="feedback-panel">
        <div class="feedback-card" id="feedback-card">
            <div class="feedback-icon" id="feedback-icon">‚ö°</div>
            <h2 class="feedback-title" id="feedback-title">Decision Made</h2>
            <p class="feedback-explanation" id="feedback-explanation">Explanation loading...</p>
            <div class="ai-suggestion">
                <div class="ai-label">ü§ñ AI Recommendation</div>
                <p class="ai-text" id="ai-recommendation">AI analysis loading...</p>
            </div>
            <button class="continue-btn" onclick="nextScenario()">Continue ‚Üí</button>
        </div>
    </div>

    <!-- Final Report -->
    <div id="final-report">
        <div class="report-container">
            <div class="report-header">
                <h1 class="report-title">Simulation Complete</h1>
                <p class="report-subtitle">24-Hour Energy Management Analysis</p>
            </div>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="final-score" style="color: #00ff88;">0</div>
                    <div class="metric-label">Final Score</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="final-renewable" style="color: #00d4ff;">0%</div>
                    <div class="metric-label">Renewable Usage</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="final-savings" style="color: #8b5cf6;">¬£0</div>
                    <div class="metric-label">Cost Savings</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="final-carbon" style="color: #ffaa00;">0kg</div>
                    <div class="metric-label">CO‚ÇÇ Avoided</div>
                </div>
            </div>
            
            <div class="comparison-section">
                <h3 class="section-title">üìä Your Decisions vs AI Optimization</h3>
                <div class="comparison-bars">
                    <div class="bar-item">
                        <span class="bar-label">Your Score</span>
                        <div class="bar-container">
                            <div class="bar-fill user" id="user-bar" style="width: 0%;"></div>
                        </div>
                        <span class="bar-value" id="user-score-final">0</span>
                    </div>
                    <div class="bar-item">
                        <span class="bar-label">AI Optimal</span>
                        <div class="bar-container">
                            <div class="bar-fill ai" id="ai-bar" style="width: 0%;"></div>
                        </div>
                        <span class="bar-value" id="ai-score-final">0</span>
                    </div>
                </div>
            </div>
            
            <div class="insights-section">
                <h3 class="section-title">üéì Academic Insights</h3>
                <div id="academic-insights"></div>
            </div>
            
            <div class="academic-references">
                <h4 class="ref-title">Key Theoretical Frameworks</h4>
                <div class="ref-item">Nash Equilibrium in P2P Energy Markets: Optimal pricing strategies emerge when prosumers maximize individual utility while market clears.</div>
                <div class="ref-item">LSTM Neural Networks for Time-Series Forecasting: Recurrent architectures capture temporal dependencies in energy consumption patterns.</div>
                <div class="ref-item">Mechanism Design Theory: Incentive-compatible trading rules ensure truthful revelation of preferences and capacities.</div>
                <div class="ref-item">Distributed Ledger Technology: Blockchain enables trustless settlement and immutable transaction records in decentralized markets.</div>
            </div>
            
            <button class="restart-btn" onclick="restartSimulation()">üîÑ Run Simulation Again</button>
        </div>
    </div>

    <!-- A-Frame VR Scene -->
    <a-scene 
        embedded 
        vr-mode-ui="enabled: true"
        renderer="antialias: true; colorManagement: true; physicallyCorrectLights: true"
        id="vr-scene">
        
        <!-- Assets -->
        <a-assets>
            <img id="sky-texture" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='2048' height='1024'%3E%3Cdefs%3E%3ClinearGradient id='sky' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23001122'/%3E%3Cstop offset='50%25' style='stop-color:%23003366'/%3E%3Cstop offset='100%25' style='stop-color:%23112244'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect fill='url(%23sky)' width='2048' height='1024'/%3E%3C/svg%3E">
        </a-assets>

        <!-- Environment -->
        <a-sky color="#0a1628" id="sky-element"></a-sky>
        <a-entity environment="preset: starry; groundColor: #0a1628; groundColor2: #112244; fog: 0.7; dressingAmount: 0"></a-entity>
        
        <!-- Ground Grid -->
        <a-entity id="ground-grid" position="0 0.01 0" rotation="-90 0 0">
            <a-plane 
                width="100" 
                height="100" 
                color="#0a1628"
                opacity="0.9"
                material="shader: flat">
            </a-plane>
        </a-entity>
        
        <!-- Village Center - Community Hub -->
        <a-entity id="community-hub" position="0 0 -8">
            <!-- Main Building -->
            <a-box 
                position="0 1.5 0" 
                width="4" height="3" depth="4"
                color="#1a2a4a"
                material="metalness: 0.3; roughness: 0.7">
            </a-box>
            <a-box 
                position="0 3.5 0" 
                width="3.5" height="1" depth="3.5"
                color="#2a3a5a"
                material="metalness: 0.3; roughness: 0.7">
            </a-box>
            
            <!-- Energy Display Screen -->
            <a-plane 
                position="0 2 2.01" 
                width="3" height="1.5"
                color="#000"
                material="shader: flat">
            </a-plane>
            <a-text 
                id="hub-display"
                position="0 2.3 2.02" 
                value="COMMUNITY ENERGY HUB"
                color="#00ff88"
                align="center"
                width="4"
                font="monoid">
            </a-text>
            <a-text 
                id="hub-status"
                position="0 1.8 2.02" 
                value="Status: Initializing..."
                color="#00d4ff"
                align="center"
                width="3"
                font="monoid">
            </a-text>
            
            <!-- Glowing Ring -->
            <a-ring 
                position="0 0.1 0" 
                rotation="-90 0 0"
                radius-inner="3" radius-outer="3.2"
                color="#00ff88"
                material="shader: flat; opacity: 0.5"
                animation="property: rotation; to: -90 360 0; dur: 20000; loop: true; easing: linear">
            </a-ring>
        </a-entity>
        
        <!-- Solar Panel Array -->
        <a-entity id="solar-array" position="-15 0 -5">
            <!-- Panel 1 -->
            <a-entity position="0 0 0">
                <a-box position="0 1.5 0" width="0.2" height="3" depth="0.2" color="#444"></a-box>
                <a-box 
                    id="solar-panel-1"
                    position="0 3 0" 
                    rotation="-30 0 0"
                    width="4" height="0.1" depth="2.5"
                    color="#1a3a6a"
                    material="metalness: 0.8; roughness: 0.2">
                </a-box>
            </a-entity>
            <!-- Panel 2 -->
            <a-entity position="5 0 0">
                <a-box position="0 1.5 0" width="0.2" height="3" depth="0.2" color="#444"></a-box>
                <a-box 
                    id="solar-panel-2"
                    position="0 3 0" 
                    rotation="-30 0 0"
                    width="4" height="0.1" depth="2.5"
                    color="#1a3a6a"
                    material="metalness: 0.8; roughness: 0.2">
                </a-box>
            </a-entity>
            <!-- Solar Status Light -->
            <a-sphere 
                id="solar-indicator"
                position="2.5 5 0" 
                radius="0.3"
                color="#333"
                material="shader: flat; emissive: #333; emissiveIntensity: 0.5">
            </a-sphere>
            <a-text 
                position="2.5 6 0" 
                value="SOLAR ARRAY"
                color="#666"
                align="center"
                width="6"
                font="monoid">
            </a-text>
        </a-entity>
        
        <!-- Wind Turbine -->
        <a-entity id="wind-turbine" position="15 0 -10">
            <!-- Tower -->
            <a-cylinder 
                position="0 7.5 0" 
                radius="0.3" height="15"
                color="#ddd"
                material="metalness: 0.5; roughness: 0.5">
            </a-cylinder>
            <!-- Nacelle -->
            <a-box 
                position="0 15 0.5" 
                width="1" height="1" depth="2"
                color="#eee"
                material="metalness: 0.5; roughness: 0.5">
            </a-box>
            <!-- Blades -->
            <a-entity 
                id="turbine-blades"
                position="0 15 1.6"
                animation="property: rotation; to: 0 0 360; dur: 3000; loop: true; easing: linear">
                <a-box position="0 3 0" width="0.3" height="6" depth="0.1" color="#fff"></a-box>
                <a-box position="2.6 -1.5 0" rotation="0 0 120" width="0.3" height="6" depth="0.1" color="#fff"></a-box>
                <a-box position="-2.6 -1.5 0" rotation="0 0 240" width="0.3" height="6" depth="0.1" color="#fff"></a-box>
            </a-entity>
            <!-- Status Light -->
            <a-sphere 
                id="wind-indicator"
                position="0 17 0" 
                radius="0.2"
                color="#00ff88"
                material="shader: flat; emissive: #00ff88; emissiveIntensity: 1">
            </a-sphere>
            <a-text 
                position="0 0.5 3" 
                value="WIND TURBINE"
                color="#666"
                align="center"
                width="6"
                font="monoid">
            </a-text>
        </a-entity>
        
        <!-- Battery Storage -->
        <a-entity id="battery-storage" position="8 0 5">
            <!-- Battery Units -->
            <a-box position="-1.5 1 0" width="1.2" height="2" depth="2" color="#2a4a2a" material="metalness: 0.4; roughness: 0.6"></a-box>
            <a-box position="0 1 0" width="1.2" height="2" depth="2" color="#2a4a2a" material="metalness: 0.4; roughness: 0.6"></a-box>
            <a-box position="1.5 1 0" width="1.2" height="2" depth="2" color="#2a4a2a" material="metalness: 0.4; roughness: 0.6"></a-box>
            
            <!-- Battery Level Indicator -->
            <a-box 
                id="battery-fill"
                position="0 1 1.01" 
                width="4" height="1.8" depth="0.05"
                color="#00ff88"
                material="shader: flat; opacity: 0.3">
            </a-box>
            <a-text 
                id="battery-text"
                position="0 2.5 1.02" 
                value="BATTERY: 50%"
                color="#00ff88"
                align="center"
                width="5"
                font="monoid">
            </a-text>
            <a-text 
                position="0 0.5 1.5" 
                value="ENERGY STORAGE"
                color="#666"
                align="center"
                width="6"
                font="monoid">
            </a-text>
        </a-entity>
        
        <!-- Houses (Prosumers) -->
        <!-- House 1 -->
        <a-entity id="house-1" position="-8 0 8">
            <a-box position="0 1.25 0" width="3" height="2.5" depth="3" color="#3a3a4a" material="metalness: 0.2; roughness: 0.8"></a-box>
            <a-entity geometry="primitive: cone; radiusBottom: 2.5; radiusTop: 0; height: 2" position="0 3 0" rotation="0 45 0" material="color: #4a3a3a"></a-entity>
            <a-box position="0 2.5 1.2" rotation="-20 0 0" width="2" height="0.1" depth="1.5" color="#1a3a6a"></a-box>
            <a-sphere id="house-1-indicator" position="0 4.5 0" radius="0.15" color="#00ff88" material="shader: flat; emissive: #00ff88; emissiveIntensity: 1"></a-sphere>
            <a-text position="0 0.5 2" value="PROSUMER A" color="#666" align="center" width="4" font="monoid"></a-text>
        </a-entity>
        
        <!-- House 2 -->
        <a-entity id="house-2" position="-12 0 12">
            <a-box position="0 1.25 0" width="3" height="2.5" depth="3" color="#3a4a4a" material="metalness: 0.2; roughness: 0.8"></a-box>
            <a-entity geometry="primitive: cone; radiusBottom: 2.5; radiusTop: 0; height: 2" position="0 3 0" rotation="0 45 0" material="color: #3a4a4a"></a-entity>
            <a-sphere id="house-2-indicator" position="0 4.5 0" radius="0.15" color="#ffaa00" material="shader: flat; emissive: #ffaa00; emissiveIntensity: 1"></a-sphere>
            <a-text position="0 0.5 2" value="CONSUMER B" color="#666" align="center" width="4" font="monoid"></a-text>
        </a-entity>
        
        <!-- House 3 -->
        <a-entity id="house-3" position="-4 0 14">
            <a-box position="0 1.25 0" width="3" height="2.5" depth="3" color="#4a3a4a" material="metalness: 0.2; roughness: 0.8"></a-box>
            <a-entity geometry="primitive: cone; radiusBottom: 2.5; radiusTop: 0; height: 2" position="0 3 0" rotation="0 45 0" material="color: #4a4a3a"></a-entity>
            <a-box position="0 2.5 1.2" rotation="-20 0 0" width="2" height="0.1" depth="1.5" color="#1a3a6a"></a-box>
            <a-sphere id="house-3-indicator" position="0 4.5 0" radius="0.15" color="#00ff88" material="shader: flat; emissive: #00ff88; emissiveIntensity: 1"></a-sphere>
            <a-text position="0 0.5 2" value="PROSUMER C" color="#666" align="center" width="4" font="monoid"></a-text>
        </a-entity>
        
        <!-- Grid Connection -->
        <a-entity id="grid-connection" position="20 0 0">
            <a-cylinder position="0 6 0" radius="0.15" height="12" color="#666"></a-cylinder>
            <a-cylinder position="3 6 0" radius="0.15" height="12" color="#666"></a-cylinder>
            <a-cylinder position="1.5 11 0" rotation="0 0 90" radius="0.1" height="4" color="#666"></a-cylinder>
            <a-cylinder position="1.5 9 0" rotation="0 0 90" radius="0.1" height="4" color="#666"></a-cylinder>
            <a-box position="1.5 3 0" width="2" height="1.5" depth="1" color="#444"></a-box>
            <a-sphere id="grid-indicator" position="1.5 4 0" radius="0.2" color="#ff4444" material="shader: flat; emissive: #ff4444; emissiveIntensity: 0.5"></a-sphere>
            <a-text position="1.5 0.5 1" value="MAIN GRID" color="#666" align="center" width="5" font="monoid"></a-text>
        </a-entity>
        
        <!-- Energy Flow Lines (animated) -->
        <a-entity id="energy-flows">
            <!-- Solar to Hub -->
            <a-entity id="flow-solar-hub" visible="false">
                <a-sphere position="-10 3 -5" radius="0.1" color="#ffcc00" material="shader: flat; emissive: #ffcc00; emissiveIntensity: 2"
                    animation="property: position; to: 0 3 -8; dur: 1500; loop: true"></a-sphere>
            </a-entity>
            <!-- Wind to Hub -->
            <a-entity id="flow-wind-hub" visible="true">
                <a-sphere position="15 10 -10" radius="0.1" color="#00ffcc" material="shader: flat; emissive: #00ffcc; emissiveIntensity: 2"
                    animation="property: position; to: 0 3 -8; dur: 2000; loop: true"></a-sphere>
            </a-entity>
            <!-- Hub to Battery -->
            <a-entity id="flow-hub-battery" visible="false">
                <a-sphere position="0 2 -6" radius="0.1" color="#00ff88" material="shader: flat; emissive: #00ff88; emissiveIntensity: 2"
                    animation="property: position; to: 8 2 5; dur: 1500; loop: true"></a-sphere>
            </a-entity>
            <!-- Hub to Houses -->
            <a-entity id="flow-hub-houses" visible="false">
                <a-sphere position="0 2 -6" radius="0.1" color="#8b5cf6" material="shader: flat; emissive: #8b5cf6; emissiveIntensity: 2"
                    animation="property: position; to: -8 2 8; dur: 1500; loop: true"></a-sphere>
            </a-entity>
        </a-entity>
        
        <!-- Floating Data Particles -->
        <a-entity id="data-particles">
            <a-sphere position="-5 4 -3" radius="0.05" color="#00ff88" material="shader: flat; emissive: #00ff88"
                animation="property: position; to: -3 6 -5; dur: 4000; loop: true; dir: alternate"></a-sphere>
            <a-sphere position="5 3 -2" radius="0.05" color="#00d4ff" material="shader: flat; emissive: #00d4ff"
                animation="property: position; to: 7 5 -4; dur: 3500; loop: true; dir: alternate"></a-sphere>
            <a-sphere position="0 5 -10" radius="0.05" color="#8b5cf6" material="shader: flat; emissive: #8b5cf6"
                animation="property: position; to: 2 7 -12; dur: 4500; loop: true; dir: alternate"></a-sphere>
        </a-entity>
        
        <!-- Sun/Moon -->
        <a-entity id="celestial-body" position="-30 5 -50">
            <a-sphere 
                id="sun-moon"
                radius="3"
                color="#222"
                material="shader: flat; emissive: #111; emissiveIntensity: 0.5">
            </a-sphere>
        </a-entity>
        
        <!-- VR Info Panels -->
        <a-entity id="vr-info-panel" position="0 2 -4">
            <a-plane 
                width="3" height="1.5"
                color="#0a0a0f"
                material="shader: flat; opacity: 0.9">
            </a-plane>
            <a-text 
                id="vr-scenario-text"
                position="0 0.4 0.01" 
                value="Welcome to Energy Manager VR"
                color="#00ff88"
                align="center"
                width="4"
                font="monoid">
            </a-text>
            <a-text 
                id="vr-instruction-text"
                position="0 0 0.01" 
                value="Make decisions to optimize\ncommunity energy trading"
                color="#aaa"
                align="center"
                width="3.5"
                font="monoid">
            </a-text>
        </a-entity>
        
        <!-- VR Decision Buttons -->
        <a-entity id="vr-buttons" position="0 1.2 -3" visible="false">
            <a-entity class="vr-option" position="-1.5 0 0">
                <a-box 
                    class="clickable"
                    width="1.2" height="0.6" depth="0.1"
                    color="#1a3a2a"
                    material="shader: flat"
                    data-option="0">
                </a-box>
                <a-text 
                    position="0 0 0.06" 
                    value="Option A"
                    color="#00ff88"
                    align="center"
                    width="2"
                    font="monoid">
                </a-text>
            </a-entity>
            <a-entity class="vr-option" position="0 0 0">
                <a-box 
                    class="clickable"
                    width="1.2" height="0.6" depth="0.1"
                    color="#2a3a4a"
                    material="shader: flat"
                    data-option="1">
                </a-box>
                <a-text 
                    position="0 0 0.06" 
                    value="Option B"
                    color="#00d4ff"
                    align="center"
                    width="2"
                    font="monoid">
                </a-text>
            </a-entity>
            <a-entity class="vr-option" position="1.5 0 0">
                <a-box 
                    class="clickable"
                    width="1.2" height="0.6" depth="0.1"
                    color="#3a2a4a"
                    material="shader: flat"
                    data-option="2">
                </a-box>
                <a-text 
                    position="0 0 0.06" 
                    value="Option C"
                    color="#8b5cf6"
                    align="center"
                    width="2"
                    font="monoid">
                </a-text>
            </a-entity>
        </a-entity>
        
        <!-- Lighting -->
        <a-light type="ambient" color="#334" intensity="0.4"></a-light>
        <a-light type="directional" color="#fff" intensity="0.3" position="-1 2 1"></a-light>
        <a-light id="scene-light" type="point" color="#00ff88" intensity="0.5" position="0 10 -8" distance="50"></a-light>
        
        <!-- Camera Rig -->
        <a-entity id="rig" position="0 0 10">
            <a-camera 
                position="0 1.6 0"
                look-controls="pointerLockEnabled: false"
                wasd-controls="acceleration: 30">
                <a-cursor 
                    color="#00ff88" 
                    fuse="true" 
                    fuse-timeout="1500"
                    raycaster="objects: .clickable">
                </a-cursor>
            </a-camera>
        </a-entity>
        
    </a-scene>

    <button class="vr-enter-btn" onclick="enterVR()">
        ü•Ω Enter VR Mode
    </button>

    <script>
        // ==========================================
        // GAME STATE & CONFIGURATION
        // ==========================================
        
        const GameState = {
            currentScenario: 0,
            score: 0,
            totalRenewable: 0,
            totalConsumed: 0,
            costSavings: 0,
            carbonAvoided: 0,
            decisions: [],
            aiScore: 0,
            batteryLevel: 50,
            isVRMode: false
        };
        
        // ==========================================
        // SCENARIO DATABASE (Academic Level)
        // ==========================================
        
        const scenarios = [
            {
                time: "06:00",
                period: "Early Morning",
                title: "Pre-Dawn Energy Strategy",
                context: "Solar generation is zero. Wind output is moderate at 2.1 kW. Battery reserves at 50%. Community demand beginning to rise as households wake. Grid electricity prices are at off-peak rates (¬£0.15/kWh). Weather forecast indicates clear skies ahead.",
                solarOutput: 0,
                windOutput: 2.1,
                gridPrice: 0.15,
                demand: 4.5,
                options: [
                    {
                        text: "‚ö° Import from grid now",
                        action: "import_grid",
                        impact: { score: 60, renewable: 0, cost: -2.5, carbon: 0 },
                        explanation: "Importing during off-peak hours captures lower rates, but relies on non-renewable grid power, increasing carbon footprint.",
                        isOptimal: false
                    },
                    {
                        text: "üîã Use battery reserves",
                        action: "use_battery",
                        impact: { score: 75, renewable: 85, cost: 0, carbon: 1.2 },
                        explanation: "Utilizing stored renewable energy maintains sustainability metrics and avoids grid dependency during morning ramp-up.",
                        isOptimal: true
                    },
                    {
                        text: "üìä Defer non-essential loads",
                        action: "demand_response",
                        impact: { score: 70, renewable: 100, cost: 0.5, carbon: 0.8 },
                        explanation: "Implementing demand response shifts flexible consumption to upcoming solar peak hours, optimizing renewable utilization."
                    }
                ],
                aiRecommendation: "At 06:00, the AI system would recommend using battery reserves for immediate demand while scheduling non-essential loads (EV charging, water heating) for the anticipated solar peak between 11:00-14:00. This maximizes renewable energy utilization and minimizes grid dependency. The LSTM forecasting model predicts 95% confidence of strong solar output from 10:00 onwards.",
                academicNote: "This scenario demonstrates temporal arbitrage in energy markets. The optimal strategy involves intertemporal optimization where stored renewable energy (opportunity cost) is weighed against real-time grid prices (marginal cost). Reference: Parisio et al. (2014) 'A Model Predictive Control Approach to Microgrid Operation Optimization'."
            },
            {
                time: "09:00",
                period: "Morning Ramp",
                title: "Solar Generation Onset",
                context: "Solar panels now generating 3.2 kW as sun rises. Wind steady at 1.8 kW. Battery at 35% after morning usage. Community consumption at daily average. Grid prices at standard rate (¬£0.28/kWh). Three prosumers have excess generation beginning.",
                solarOutput: 3.2,
                windOutput: 1.8,
                gridPrice: 0.28,
                demand: 6.0,
                options: [
                    {
                        text: "üîã Charge community battery",
                        action: "charge_battery",
                        impact: { score: 85, renewable: 90, cost: 1.0, carbon: 1.5 },
                        explanation: "Storing excess renewable generation prepares for evening peak demand when solar output drops but consumption spikes.",
                        isOptimal: true
                    },
                    {
                        text: "üí∞ Sell excess to grid",
                        action: "export_grid",
                        impact: { score: 65, renewable: 75, cost: 0.8, carbon: 0.5 },
                        explanation: "Grid export provides immediate revenue but forfeits the opportunity to use stored energy during higher-priced evening hours."
                    },
                    {
                        text: "üè† P2P trade to Consumer B",
                        action: "p2p_trade",
                        impact: { score: 80, renewable: 95, cost: 1.2, carbon: 1.3 },
                        explanation: "Direct peer-to-peer trading keeps energy within the community, supporting local prosumers while maintaining renewable utilization."
                    }
                ],
                aiRecommendation: "The AI recommends prioritizing battery charging during mid-morning hours. Neural network analysis of historical data shows the community consistently faces a 'duck curve' pattern with evening peaks at 18:00-20:00. Storing 70% of current excess while enabling P2P trades for immediate needs optimizes both short-term community benefit and long-term resilience.",
                academicNote: "This decision point illustrates the 'duck curve' phenomenon in renewable energy systems. The mismatch between peak solar generation (midday) and peak demand (evening) necessitates storage solutions. Reference: Denholm et al. (2015) 'Overgeneration from Solar Energy in California: A Field Guide to the Duck Chart'."
            },
            {
                time: "12:00",
                period: "Solar Peak",
                title: "Maximum Renewable Generation",
                context: "Solar output at daily maximum: 8.5 kW. Wind contribution: 1.2 kW. Total renewable: 9.7 kW. Community demand only 5.2 kW. Battery at 75%. Significant surplus of 4.5 kW available. Grid offering feed-in tariff of ¬£0.08/kWh. Neighboring community requesting 3 kW purchase.",
                solarOutput: 8.5,
                windOutput: 1.2,
                gridPrice: 0.08,
                demand: 5.2,
                options: [
                    {
                        text: "üåê Export all surplus to grid",
                        action: "full_export",
                        impact: { score: 55, renewable: 100, cost: 0.36, carbon: 2.0 },
                        explanation: "Grid export at ¬£0.08/kWh feed-in tariff provides guaranteed revenue but undervalues the true worth of renewable generation."
                    },
                    {
                        text: "ü§ù Inter-community P2P sale",
                        action: "inter_community",
                        impact: { score: 90, renewable: 100, cost: 1.8, carbon: 2.5 },
                        explanation: "Selling to neighboring community at negotiated rate (¬£0.18/kWh) maximizes revenue while expanding renewable energy reach.",
                        isOptimal: true
                    },
                    {
                        text: "üîã Top up battery + partial export",
                        action: "balanced",
                        impact: { score: 80, renewable: 100, cost: 1.2, carbon: 2.2 },
                        explanation: "Hybrid approach fills battery to 95% while exporting remainder, balancing immediate revenue with evening resilience."
                    }
                ],
                aiRecommendation: "AI optimization identifies the inter-community trade as optimal. The blockchain-enabled smart contract can execute the 3 kW sale at ¬£0.18/kWh (vs ¬£0.08 grid rate), generating 125% more revenue. The AI also activates demand response protocols: pre-cooling buildings, scheduling EV charging, and running dishwashers now to maximize solar self-consumption.",
                academicNote: "This scenario exemplifies multi-agent systems theory in energy markets. The Nash equilibrium is achieved when all prosumers maximize individual utility while market clearing occurs. The inter-community trade represents a Pareto improvement over grid export. Reference: Tushar et al. (2020) 'Peer-to-Peer Trading in Electricity Networks: An Overview'."
            },
            {
                time: "15:00",
                period: "Afternoon Transition",
                title: "Declining Solar, Rising Demand",
                context: "Solar dropping to 5.1 kW as sun angle decreases. Wind picking up to 2.4 kW. Battery at 90%. Demand increasing to 6.8 kW as businesses peak. Grid price rising to ¬£0.32/kWh. Weather alert: cloud cover expected in 2 hours.",
                solarOutput: 5.1,
                windOutput: 2.4,
                gridPrice: 0.32,
                demand: 6.8,
                options: [
                    {
                        text: "‚ö° Maximize current solar use",
                        action: "solar_priority",
                        impact: { score: 75, renewable: 95, cost: 0.5, carbon: 1.0 },
                        explanation: "Prioritizing direct solar consumption while available captures value before cloud cover reduces output."
                    },
                    {
                        text: "üîã Begin strategic battery discharge",
                        action: "early_discharge",
                        impact: { score: 70, renewable: 85, cost: 0.3, carbon: 0.8 },
                        explanation: "Starting battery discharge early smooths the evening transition but may deplete reserves before peak demand."
                    },
                    {
                        text: "üìà Hold reserves, accept partial grid",
                        action: "preserve_battery",
                        impact: { score: 85, renewable: 80, cost: -0.8, carbon: 1.5 },
                        explanation: "Preserving battery for evening peak (when prices reach ¬£0.45/kWh) maximizes economic value despite temporary grid reliance.",
                        isOptimal: true
                    }
                ],
                aiRecommendation: "The AI's predictive model factors in the weather alert and historical price patterns. It recommends holding battery at 85%+ for the 18:00-20:00 peak when prices average 40% higher. The remaining solar covers 75% of current demand; the AI accepts strategic grid import now at ¬£0.32/kWh versus ¬£0.45/kWh evening rates, optimizing total daily cost.",
                academicNote: "This demonstrates predictive optimization under uncertainty. The AI employs stochastic programming to handle weather forecast uncertainty while optimizing expected outcomes. The value of perfect information (EVPI) in this scenario shows that accurate weather prediction improves outcomes by 15-20%. Reference: Morales et al. (2013) 'Integrating Renewables in Electricity Markets'."
            },
            {
                time: "18:00",
                period: "Evening Peak",
                title: "Critical Demand Period",
                context: "Solar output collapsed to 0.8 kW (cloudy). Wind strong at 3.5 kW. Battery at 82%. Community demand spiking to 12.5 kW as residents return home. Grid price at peak: ¬£0.45/kWh. Three EVs requesting charging. Prosumer A has 2 kWh stored excess.",
                solarOutput: 0.8,
                windOutput: 3.5,
                gridPrice: 0.45,
                demand: 12.5,
                options: [
                    {
                        text: "üîã Full battery discharge",
                        action: "max_discharge",
                        impact: { score: 70, renewable: 75, cost: 2.0, carbon: 2.5 },
                        explanation: "Maximizing battery output meets demand but may leave insufficient reserves for overnight and morning periods."
                    },
                    {
                        text: "‚öñÔ∏è Balanced supply mix",
                        action: "balanced_supply",
                        impact: { score: 90, renewable: 70, cost: 1.5, carbon: 2.8 },
                        explanation: "Combining battery (50%), wind, P2P (Prosumer A), and minimal grid optimizes across cost, sustainability, and resilience.",
                        isOptimal: true
                    },
                    {
                        text: "üöó Defer EV charging entirely",
                        action: "ev_defer",
                        impact: { score: 65, renewable: 85, cost: 1.0, carbon: 1.5 },
                        explanation: "Pushing all EV loads to overnight reduces immediate stress but may disappoint users and creates late-night demand spike."
                    }
                ],
                aiRecommendation: "The AI orchestrates a sophisticated supply mix: 5 kW from battery (maintaining 45% reserve), 3.5 kW wind, 2 kWh P2P from Prosumer A at ¬£0.35/kWh, and 2 kW grid import. For EVs, it implements smart charging: one immediate (user has early departure), two deferred with guaranteed completion by 06:00. This satisfies 92% of demand from local/renewable sources.",
                academicNote: "This peak period demonstrates the value of coordinated demand response. Vehicle-to-Grid (V2G) potential is noted but not utilized here due to user preferences. The optimization problem becomes a mixed-integer program with user utility constraints. Reference: Beaude et al. (2016) 'Reducing the Impact of EV Charging Operations on the Distribution Network'."
            },
            {
                time: "21:00",
                period: "Evening Decline",
                title: "Post-Peak Recovery",
                context: "Solar zero. Wind steady at 2.8 kW. Battery at 40% after peak support. Demand falling to 7.2 kW. Grid at shoulder rate: ¬£0.22/kWh. Night rate (¬£0.10/kWh) begins at 23:00. Two EVs now connected, awaiting charge.",
                solarOutput: 0,
                windOutput: 2.8,
                gridPrice: 0.22,
                demand: 7.2,
                options: [
                    {
                        text: "‚è∞ Start EV charging now",
                        action: "ev_now",
                        impact: { score: 60, renewable: 40, cost: -1.2, carbon: 0.5 },
                        explanation: "Charging EVs now uses shoulder-rate grid power; faster but more expensive and carbon-intensive than waiting."
                    },
                    {
                        text: "üåô Queue all loads for night rate",
                        action: "night_queue",
                        impact: { score: 85, renewable: 50, cost: 0.8, carbon: 1.2 },
                        explanation: "Scheduling EV charging and battery replenishment for 23:00+ captures 55% cost reduction on grid imports.",
                        isOptimal: true
                    },
                    {
                        text: "üîã Use remaining battery freely",
                        action: "drain_battery",
                        impact: { score: 55, renewable: 80, cost: 0.2, carbon: 0.8 },
                        explanation: "Depleting battery maintains renewable percentage but leaves community vulnerable to overnight fluctuations."
                    }
                ],
                aiRecommendation: "AI schedules a coordinated overnight operation: EVs begin charging at 23:00 (night rate), completing by 05:30. Battery replenishment to 60% scheduled for 02:00-04:00 when grid demand is minimal. The AI also pre-conditions heat pumps at 23:30 to reduce morning heating load. This overnight orchestration saves ¬£3.40 versus immediate charging.",
                academicNote: "This showcases temporal load shifting, a key demand-side management technique. The optimal control problem minimizes total cost subject to completion constraints (EVs ready by departure time, thermal comfort maintained). Reference: Mohsenian-Rad & Leon-Garcia (2010) 'Optimal Residential Load Control With Price Prediction'."
            },
            {
                time: "02:00",
                period: "Deep Night",
                title: "Overnight System Management",
                context: "Zero solar. Wind dropped to 1.1 kW. Battery charging from grid at ¬£0.10/kWh, currently at 55%. Baseload demand 3.2 kW (refrigeration, standby, security). Both EVs at 60% charge. Weather forecast: heavy rain tomorrow, limited solar expected.",
                solarOutput: 0,
                windOutput: 1.1,
                gridPrice: 0.10,
                demand: 3.2,
                options: [
                    {
                        text: "üîã Aggressive battery charging",
                        action: "max_charge",
                        impact: { score: 90, renewable: 30, cost: 1.5, carbon: 0.5 },
                        explanation: "Filling battery to 95% prepares for tomorrow's reduced solar output, leveraging lowest grid rates.",
                        isOptimal: true
                    },
                    {
                        text: "‚ö° Standard overnight profile",
                        action: "standard_night",
                        impact: { score: 70, renewable: 35, cost: 0.8, carbon: 0.3 },
                        explanation: "Continuing normal operations reaches ~70% battery but may leave shortage during cloudy day."
                    },
                    {
                        text: "üí§ Minimal activity mode",
                        action: "minimal",
                        impact: { score: 55, renewable: 40, cost: 0.2, carbon: 0.2 },
                        explanation: "Reducing all charging minimizes immediate costs but doesn't prepare for forecasted low-generation day."
                    }
                ],
                aiRecommendation: "Given the rainy day forecast, the AI prioritizes resilience over short-term optimization. It schedules aggressive battery charging to 95% by 05:30, accepting higher grid usage but at minimal cost (¬£0.10/kWh). The AI also pre-emptively notifies prosumers of expected lower generation, suggesting they delay any high-consumption activities to the following sunny day.",
                academicNote: "This scenario highlights the importance of weather-aware optimization. The AI's LSTM model processes multi-day forecasts to adjust storage targets. The expected value calculation shows that preparing for a low-generation day (even using grid power) outperforms reactive strategies. Reference: Wang et al. (2019) 'Deep Reinforcement Learning for Energy Management in Microgrids'."
            },
            {
                time: "07:00",
                period: "Day 2 Morning",
                title: "Rainy Day Adaptation",
                context: "Heavy cloud cover, solar only 0.4 kW. Wind moderate at 2.0 kW. Battery at 92% (well-prepared). Demand rising to 5.8 kW. Grid at off-peak ¬£0.15/kWh. Forecast shows clearing by afternoon with strong solar 14:00-18:00.",
                solarOutput: 0.4,
                windOutput: 2.0,
                gridPrice: 0.15,
                demand: 5.8,
                options: [
                    {
                        text: "üîã Rely on battery reserves",
                        action: "battery_primary",
                        impact: { score: 85, renewable: 90, cost: 0, carbon: 1.8 },
                        explanation: "Yesterday's preparation pays off‚Äîstored renewable energy covers morning demand while preserving grid independence.",
                        isOptimal: true
                    },
                    {
                        text: "‚ö° Import grid to preserve battery",
                        action: "preserve_for_later",
                        impact: { score: 70, renewable: 40, cost: -1.0, carbon: 0.5 },
                        explanation: "Saving battery for potential afternoon needs makes sense, but forecast suggests this won't be necessary."
                    },
                    {
                        text: "üì¢ Community demand reduction alert",
                        action: "demand_alert",
                        impact: { score: 75, renewable: 85, cost: 0.5, carbon: 1.5 },
                        explanation: "Requesting voluntary conservation supports community resilience but impacts user comfort."
                    }
                ],
                aiRecommendation: "The AI confidently deploys battery reserves, knowing the overnight preparation created exactly this capability. With 92% battery and clearing forecast for afternoon, there's no need to either import grid power or burden users with conservation requests. The AI schedules battery discharge to maintain 40% by 14:00, when solar recovery will enable recharging.",
                academicNote: "This validates the multi-day optimization strategy. The preparation cost (overnight grid charging) is justified by the improved renewable percentage and avoided peak pricing. This exemplifies the principle of 'storage as insurance' in renewable-heavy grids. Reference: Sioshansi et al. (2009) 'The Value of Electricity Storage in Competitive Markets'."
            }
        ];
        
        // ==========================================
        // INITIALIZATION
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                document.getElementById('loading-overlay').classList.add('hidden');
                startGame();
            }, 2500);
        });
        
        function startGame() {
            GameState.currentScenario = 0;
            GameState.score = 0;
            GameState.totalRenewable = 0;
            GameState.totalConsumed = 0;
            GameState.costSavings = 0;
            GameState.carbonAvoided = 0;
            GameState.decisions = [];
            GameState.batteryLevel = 50;
            
            updateHUD();
            showScenario(0);
        }
        
        function updateHUD() {
            const scenario = scenarios[GameState.currentScenario] || scenarios[0];
            
            document.getElementById('time-display').innerHTML = 
                `${scenario.time}<span class="hud-unit">hrs</span>`;
            document.getElementById('solar-output').textContent = 
                `${scenario.solarOutput} kW`;
            document.getElementById('wind-output').textContent = 
                `${scenario.windOutput} kW`;
            document.getElementById('battery-level').textContent = 
                `${GameState.batteryLevel}%`;
            document.getElementById('grid-price').textContent = 
                `¬£${scenario.gridPrice.toFixed(2)}`;
            document.getElementById('score').textContent = GameState.score;
            
            const renewablePct = GameState.totalConsumed > 0 
                ? Math.round((GameState.totalRenewable / GameState.totalConsumed) * 100) 
                : 0;
            document.getElementById('renewable-pct').textContent = `${renewablePct}%`;
            
            // Update VR scene elements
            updateVRScene(scenario);
        }
        
        function updateVRScene(scenario) {
            // Update sun position and color based on time
            const sunMoon = document.getElementById('sun-moon');
            const skyElement = document.getElementById('sky-element');
            const sceneLight = document.getElementById('scene-light');
            
            const hour = parseInt(scenario.time.split(':')[0]);
            
            // Calculate sun position (arc across sky)
            const sunAngle = ((hour - 6) / 12) * Math.PI;
            const sunX = -30 + Math.sin(sunAngle) * 40;
            const sunY = Math.max(5, Math.sin(sunAngle) * 40);
            
            const celestial = document.getElementById('celestial-body');
            celestial.setAttribute('position', `${sunX} ${sunY} -50`);
            
            // Day/night colors
            if (hour >= 6 && hour <= 18) {
                const intensity = Math.sin(sunAngle);
                sunMoon.setAttribute('color', '#ffcc44');
                sunMoon.setAttribute('material', `shader: flat; emissive: #ffcc44; emissiveIntensity: ${intensity}`);
                skyElement.setAttribute('color', `rgb(${10 + intensity * 40}, ${20 + intensity * 60}, ${40 + intensity * 80})`);
                sceneLight.setAttribute('intensity', 0.3 + intensity * 0.7);
            } else {
                sunMoon.setAttribute('color', '#aabbcc');
                sunMoon.setAttribute('material', 'shader: flat; emissive: #334455; emissiveIntensity: 0.3');
                skyElement.setAttribute('color', '#0a1020');
                sceneLight.setAttribute('intensity', 0.2);
            }
            
            // Update solar indicator
            const solarIndicator = document.getElementById('solar-indicator');
            if (scenario.solarOutput > 5) {
                solarIndicator.setAttribute('color', '#ffcc00');
                solarIndicator.setAttribute('material', 'shader: flat; emissive: #ffcc00; emissiveIntensity: 2');
            } else if (scenario.solarOutput > 1) {
                solarIndicator.setAttribute('color', '#ffaa00');
                solarIndicator.setAttribute('material', 'shader: flat; emissive: #ffaa00; emissiveIntensity: 1');
            } else {
                solarIndicator.setAttribute('color', '#333');
                solarIndicator.setAttribute('material', 'shader: flat; emissive: #333; emissiveIntensity: 0.2');
            }
            
            // Update wind turbine speed
            const turbineBlades = document.getElementById('turbine-blades');
            const windSpeed = 1000 + (4 - scenario.windOutput) * 1000;
            turbineBlades.setAttribute('animation', `property: rotation; to: 0 0 360; dur: ${windSpeed}; loop: true; easing: linear`);
            
            // Update battery visual
            const batteryFill = document.getElementById('battery-fill');
            const fillHeight = (GameState.batteryLevel / 100) * 1.8;
            batteryFill.setAttribute('height', fillHeight);
            batteryFill.setAttribute('position', `0 ${0.1 + fillHeight/2} 1.01`);
            
            const batteryColor = GameState.batteryLevel > 60 ? '#00ff88' : 
                                  GameState.batteryLevel > 30 ? '#ffaa00' : '#ff4444';
            batteryFill.setAttribute('color', batteryColor);
            
            document.getElementById('battery-text').setAttribute('value', `BATTERY: ${GameState.batteryLevel}%`);
            
            // Update hub status
            document.getElementById('hub-status').setAttribute('value', 
                `Solar: ${scenario.solarOutput}kW | Wind: ${scenario.windOutput}kW`);
            
            // Energy flow visualizations
            document.getElementById('flow-solar-hub').setAttribute('visible', scenario.solarOutput > 1);
            document.getElementById('flow-wind-hub').setAttribute('visible', scenario.windOutput > 1);
            
            // Update VR info panel
            document.getElementById('vr-scenario-text').setAttribute('value', 
                `${scenario.time} - ${scenario.period}`);
            document.getElementById('vr-instruction-text').setAttribute('value', 
                scenario.title);
        }
        
        function showScenario(index) {
            if (index >= scenarios.length) {
                showFinalReport();
                return;
            }
            
            const scenario = scenarios[index];
            GameState.currentScenario = index;
            
            updateHUD();
            
            // Update decision panel
            document.getElementById('scenario-time').textContent = 
                `${scenario.time} - ${scenario.period}`;
            document.getElementById('scenario-title').textContent = scenario.title;
            document.getElementById('scenario-context').textContent = scenario.context;
            
            // Generate option buttons
            const optionsContainer = document.getElementById('decision-options');
            optionsContainer.innerHTML = '';
            
            scenario.options.forEach((option, i) => {
                const btn = document.createElement('button');
                btn.className = 'decision-btn';
                btn.innerHTML = `<span class="btn-icon">${option.text.split(' ')[0]}</span>${option.text.slice(2)}`;
                btn.onclick = () => makeDecision(i);
                optionsContainer.appendChild(btn);
            });
            
            // Show panel
            document.getElementById('decision-panel').classList.add('active');
            document.getElementById('feedback-panel').classList.remove('active');
            
            // Update VR buttons
            updateVRButtons(scenario);
        }
        
        function updateVRButtons(scenario) {
            const vrButtons = document.getElementById('vr-buttons');
            const options = vrButtons.querySelectorAll('.vr-option');
            
            options.forEach((opt, i) => {
                if (scenario.options[i]) {
                    opt.querySelector('a-text').setAttribute('value', 
                        scenario.options[i].text.split(' ')[0] + '\n' + 
                        scenario.options[i].text.split(' ').slice(1, 3).join(' '));
                }
            });
            
            vrButtons.setAttribute('visible', 'true');
        }
        
        function makeDecision(optionIndex) {
            const scenario = scenarios[GameState.currentScenario];
            const option = scenario.options[optionIndex];
            
            // Apply impacts
            GameState.score += option.impact.score;
            GameState.totalRenewable += option.impact.renewable;
            GameState.totalConsumed += 100;
            GameState.costSavings += option.impact.cost;
            GameState.carbonAvoided += option.impact.carbon;
            
            // Update battery based on action
            if (option.action.includes('charge')) {
                GameState.batteryLevel = Math.min(95, GameState.batteryLevel + 15);
            } else if (option.action.includes('discharge') || option.action.includes('battery')) {
                GameState.batteryLevel = Math.max(20, GameState.batteryLevel - 12);
            }
            
            // Track AI comparison
            const optimalOption = scenario.options.find(o => o.isOptimal);
            if (optimalOption) {
                GameState.aiScore += optimalOption.impact.score;
            }
            
            // Store decision
            GameState.decisions.push({
                scenario: GameState.currentScenario,
                chosen: optionIndex,
                wasOptimal: option.isOptimal || false
            });
            
            // Show feedback
            showFeedback(option, scenario);
        }
        
        function showFeedback(option, scenario) {
            document.getElementById('decision-panel').classList.remove('active');
            document.getElementById('vr-buttons').setAttribute('visible', 'false');
            
            const feedbackCard = document.getElementById('feedback-card');
            const feedbackIcon = document.getElementById('feedback-icon');
            const feedbackTitle = document.getElementById('feedback-title');
            
            // Determine feedback type
            if (option.isOptimal) {
                feedbackCard.className = 'feedback-card optimal';
                feedbackIcon.textContent = '‚úì';
                feedbackTitle.textContent = 'Optimal Decision!';
            } else if (option.impact.score >= 70) {
                feedbackCard.className = 'feedback-card suboptimal';
                feedbackIcon.textContent = '‚óê';
                feedbackTitle.textContent = 'Good Decision';
            } else {
                feedbackCard.className = 'feedback-card poor';
                feedbackIcon.textContent = '‚úó';
                feedbackTitle.textContent = 'Suboptimal Choice';
            }
            
            document.getElementById('feedback-explanation').textContent = option.explanation;
            document.getElementById('ai-recommendation').textContent = scenario.aiRecommendation;
            
            document.getElementById('feedback-panel').classList.add('active');
            
            updateHUD();
        }
        
        function nextScenario() {
            document.getElementById('feedback-panel').classList.remove('active');
            showScenario(GameState.currentScenario + 1);
        }
        
        function showFinalReport() {
            document.getElementById('decision-panel').classList.remove('active');
            document.getElementById('feedback-panel').classList.remove('active');
            document.getElementById('hud').style.display = 'none';
            
            const renewablePct = Math.round((GameState.totalRenewable / GameState.totalConsumed) * 100);
            
            // Populate metrics
            document.getElementById('final-score').textContent = GameState.score;
            document.getElementById('final-renewable').textContent = `${renewablePct}%`;
            document.getElementById('final-savings').textContent = `¬£${GameState.costSavings.toFixed(2)}`;
            document.getElementById('final-carbon').textContent = `${GameState.carbonAvoided.toFixed(1)}kg`;
            
            // Comparison bars
            const maxScore = scenarios.length * 90;
            const userPct = (GameState.score / maxScore) * 100;
            const aiPct = (GameState.aiScore / maxScore) * 100;
            
            document.getElementById('user-score-final').textContent = GameState.score;
            document.getElementById('ai-score-final').textContent = GameState.aiScore;
            
            setTimeout(() => {
                document.getElementById('user-bar').style.width = `${userPct}%`;
                document.getElementById('ai-bar').style.width = `${aiPct}%`;
            }, 500);
            
            // Generate academic insights
            const insightsContainer = document.getElementById('academic-insights');
            insightsContainer.innerHTML = '';
            
            const insights = generateAcademicInsights();
            insights.forEach(insight => {
                const div = document.createElement('div');
                div.className = 'insight-item';
                div.innerHTML = `
                    <div class="insight-heading">${insight.title}</div>
                    <div class="insight-text">${insight.text}</div>
                `;
                insightsContainer.appendChild(div);
            });
            
            document.getElementById('final-report').classList.add('active');
        }
        
        function generateAcademicInsights() {
            const optimalCount = GameState.decisions.filter(d => d.wasOptimal).length;
            const insights = [];
            
            insights.push({
                title: "Decision Quality Analysis",
                text: `You made ${optimalCount} of ${GameState.decisions.length} optimal decisions (${Math.round(optimalCount/GameState.decisions.length*100)}% accuracy). The AI's advantage stems from its ability to process multiple data streams simultaneously: weather forecasts, price signals, demand patterns, and storage states. Human decision-makers typically focus on 2-3 variables, while AI optimization considers 15+ factors in real-time.`
            });
            
            if (GameState.costSavings > 5) {
                insights.push({
                    title: "Economic Performance: Strong",
                    text: `Your decisions generated ¬£${GameState.costSavings.toFixed(2)} in cost savings, demonstrating effective temporal arbitrage. Key strategies included: importing during off-peak hours (¬£0.10-0.15/kWh), maximizing self-consumption during peak prices (¬£0.45/kWh), and strategic battery cycling. In a scaled community of 100 households, this approach would yield annual savings of approximately ¬£18,000-24,000.`
                });
            } else {
                insights.push({
                    title: "Economic Performance: Room for Improvement",
                    text: `Cost savings of ¬£${GameState.costSavings.toFixed(2)} indicate opportunities for better temporal optimization. The AI achieves 20-40% higher savings through precise timing of storage cycles and load shifting. Key improvement areas: exploit the spread between off-peak (¬£0.10) and peak (¬£0.45) pricing through strategic battery positioning.`
                });
            }
            
            const renewablePct = Math.round((GameState.totalRenewable / GameState.totalConsumed) * 100);
            insights.push({
                title: "Sustainability Metrics",
                text: `${renewablePct}% renewable energy utilization with ${GameState.carbonAvoided.toFixed(1)}kg CO‚ÇÇ avoided. The community microgrid model demonstrates that P2P trading combined with AI optimization can achieve 85-95% renewable utilization‚Äîsignificantly higher than traditional grid-connected scenarios (typically 40-60%). This supports the UN Sustainable Development Goal 7 (Affordable and Clean Energy).`
            });
            
            insights.push({
                title: "Theoretical Framework: Game Theory in P2P Markets",
                text: `Your participation illustrates cooperative game theory in action. Each decision represented a choice between individual optimization (selling to grid) and community benefit (P2P trading). The Nash equilibrium emerges when prosumers recognize that community-first strategies (maintaining local energy balance) yield superior collective outcomes, even if individual transactions appear suboptimal.`
            });
            
            insights.push({
                title: "Machine Learning Applications",
                text: `The AI opponent employs LSTM (Long Short-Term Memory) neural networks for time-series forecasting, achieving 94% accuracy on 24-hour predictions. The model processes: historical consumption (365 days), weather data (temperature, irradiance, cloud cover), calendar features (day-of-week, holidays), and real-time sensor inputs. This multi-variate approach exemplifies state-of-the-art energy forecasting as described in recent literature (Wang et al., 2019; Hong et al., 2020).`
            });
            
            return insights;
        }
        
        function restartSimulation() {
            document.getElementById('final-report').classList.remove('active');
            document.getElementById('hud').style.display = 'block';
            startGame();
        }
        
        function enterVR() {
            const scene = document.getElementById('vr-scene');
            if (scene.is('vr-mode')) {
                scene.exitVR();
            } else {
                scene.enterVR();
            }
        }
        
        // VR Click handlers
        document.addEventListener('DOMContentLoaded', () => {
            const clickables = document.querySelectorAll('.clickable');
            clickables.forEach(el => {
                el.addEventListener('click', (e) => {
                    const option = parseInt(e.target.getAttribute('data-option'));
                    if (!isNaN(option)) {
                        makeDecision(option);
                    }
                });
            });
        });
    </script>
</body>
</html>
